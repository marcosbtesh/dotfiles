#!/usr/bin/env bash
set -euo pipefail

app="/Applications/WezTerm.app/Contents/MacOS/wezterm"
repo="${1:-$PWD}"
target="${2:-}"

# Prefer the file if provided; otherwise open repo
open_target="$repo"
if [[ -n "$target" && "$target" != "$repo" ]]; then
  open_target="$target"
fi

# Is WezTerm running?
if osascript -e 'application "WezTerm" is running' >/dev/null 2>&1; then
  osascript -e 'tell application "WezTerm" to activate' >/dev/null 2>&1 || true
  exec "$app" cli spawn --cwd "$repo" -- nvim "$open_target"
fi

# Not running: start a new process, keep shell after nvim
exec "$app" start --cwd "$repo" -- zsh -lc 'nvim "'"$open_target"'"; exec zsh'

